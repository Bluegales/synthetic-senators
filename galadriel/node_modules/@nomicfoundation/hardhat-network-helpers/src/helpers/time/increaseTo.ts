import type { NumberLike } from "@nomicfoundation/hardhat-network-helpers/src/types";

import { getHardhatProvider, toRpcQuantity, toBigInt } from "@nomicfoundation/hardhat-network-helpers/src/utils";
import { mine } from "@nomicfoundation/hardhat-network-helpers/src/helpers/mine";
import { millis } from "@nomicfoundation/hardhat-network-helpers/src/helpers/time/duration";

/**
 * Mines a new block whose timestamp is `timestamp`
 *
 * @param timestamp Can be `Date` or Epoch seconds. Must be bigger than the latest block's timestamp
 */
export async function increaseTo(timestamp: NumberLike | Date): Promise<void> {
  const provider = await getHardhatProvider();

  const normalizedTimestamp = toBigInt(
    timestamp instanceof Date ? millis(timestamp.valueOf()) : timestamp
  );

  await provider.request({
    method: "evm_setNextBlockTimestamp",
    params: [toRpcQuantity(normalizedTimestamp)],
  });

  await mine();
}
